@implements IAsyncDisposable
@inject IJSRuntime JSRuntime

<IntersectionView @ref="_IntersectionView" class="preview-frame">
    <PooledIFrame Src="@_PreviewFrameUrl" Attached="OnPreviewIFrameAttached" Detached="OnPreviewIFrameDetached" />
</IntersectionView>

@code
{
    [Parameter, EditorRequired]
    public required Story Story { get; set; }

    [Parameter]
    public string? ViewMode { get; set; }

    [Parameter]
    public string? Id { get; set; }

    [Parameter]
    public IReadOnlyDictionary<string, object?>? Args { get; set; }

    [Parameter]
    public IReadOnlyDictionary<string, object?>? Globals { get; set; }

    [Parameter]
    public EventCallback<ComponentActionEventArgs> OnComponentAction { get; set; }

    [Parameter]
    public EventCallback<int> OnFrameScrollHeightChanged { get; set; }

    [CascadingParameter]
    internal IServiceProvider Services { get; init; } = default!;

    /// <summary>
    /// Gets the initial preview frame URL.
    /// </summary>
    public string CurrentPreviewFrameUrl => this._PreviewFrameUrl;

    private IntersectionView? _IntersectionView;

    private ElementReference _IframeContainer => this._IntersectionView?.ElementReference ?? default;

    private string _PreviewFrameUrl = "";

    private readonly JSModule _JSModule;

    private DotNetObjectReference<PreviewFrame> _ThisRef;

    private IJSObjectReference? _EventMonitorSubscriber;

    /// <summary>
    /// Initializes a new instance of the <see cref="PreviewFrame"/> class.
    /// </summary>
    public PreviewFrame()
    {
        this._JSModule = new(() => this.JSRuntime, "Internals/Components/Preview/PreviewFrame.razor.js");
        this._ThisRef = DotNetObjectReference.Create(this);
    }

    protected override void OnInitialized()
    {
        this._PreviewFrameUrl = this.GetPreviewFrameUrl();
    }

    protected override void OnParametersSet()
    {
        base.OnParametersSet();
        this._PreviewFrameUrl = this.GetPreviewFrameUrl();
    }

    private async Task OnPreviewIFrameAttached()
    {
        try
        {
            var options = Services.GetRequiredService<BlazingStoryOptions>();
            if (options.EnableHotReloading)
            {
                await EnsureDotnetWatchScriptInjected();
            }

            this._EventMonitorSubscriber = await _JSModule.InvokeAsync<IJSObjectReference>("subscribeComponentActionEvent", this._IframeContainer, this._ThisRef, nameof(ComponentActionEventCallback));
            var scrollHeight = await _JSModule.InvokeAsync<int>("getFrameScrollHeight", this._IframeContainer);
            await this.OnFrameScrollHeightChanged.InvokeAsync(scrollHeight);
        }

        // In some cases, such as when a user navigates away from the page during this async operation,
        // the JSModule may be disposed before the async operation completes.
        // Ignore the "ObjectDisposedException" exception in this case.
        catch (ObjectDisposedException) { }
    }

    private async Task OnPreviewIFrameDetached()
    {
        await this.UnsubscribeEventMonitorAsync();
    }

    private async ValueTask UnsubscribeEventMonitorAsync()
    {
        var eventMonitorSubscriber = _EventMonitorSubscriber;
        _EventMonitorSubscriber = null;
        await eventMonitorSubscriber.DisposeIfConnectedAsync("dispose");
    }

    /// <summary>
    /// Gets the URL for the preview frame, from the component parameters(args).
    /// </summary>
    private string GetPreviewFrameUrl()
    {
        // "Stringify" the component args to encode them to the URL query string.
        var args = this.Args?.ToDictionary(
            keySelector: x => x.Key,
            elementSelector: x => (object?)this.Story.Context.ConvertParameterValueToString(x.Key, x.Value)
        );

        return UriParameterKit.GetUri(
            uri: "./iframe.html",
            parameters: new Dictionary<string, object?>
                {
                    ["viewMode"] = this.ViewMode,
                    ["id"] = this.Id,
                    ["args"] = UriParameterKit.EncodeKeyValues(args),
                    ["globals"] = UriParameterKit.EncodeKeyValues(this.Globals)
                });
    }


    internal async ValueTask ReloadAsync()
    {
        await this._JSModule.InvokeVoidAsync("reloadPreviewFrame", this._IframeContainer);
    }

    internal async ValueTask ZoomInAsync()
    {
        await this._JSModule.InvokeVoidAsync("zoomInPreviewFrame", this._IframeContainer);
    }

    internal async ValueTask ZoomOutAsync()
    {
        await this._JSModule.InvokeVoidAsync("zoomOutPreviewFrame", this._IframeContainer);
    }

    internal async ValueTask ResetZoomAsync()
    {
        await this._JSModule.InvokeVoidAsync("resetZoomPreviewFrame", this._IframeContainer);
    }

    private async ValueTask EnsureDotnetWatchScriptInjected()
    {
        await this._JSModule.InvokeVoidAsync("ensureDotnetWatchScriptInjected", this._IframeContainer);
    }

    [JSInvokable(nameof(ComponentActionEventCallback))]
    public async Task ComponentActionEventCallback(string name, string argsJson)
    {
        await this.OnComponentAction.InvokeAsync(new(name, argsJson));
    }

    public async ValueTask DisposeAsync()
    {
        await this.UnsubscribeEventMonitorAsync();
        await _JSModule.DisposeAsync();
        _ThisRef.Dispose();
    }
}